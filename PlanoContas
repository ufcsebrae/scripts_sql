-- Inicia a Common Table Expression (CTE)
WITH PLANO_CONTAS AS (
    SELECT DISTINCT
        -- Contas e Descrições de todos os níveis
        Nivel6.CODCONTA COLLATE Latin1_General_CI_AS as cdgContaNvl6,
        Nivel6.[REDUZIDO] COLLATE Latin1_General_CI_AS as cdgReduzido,
        Nivel6.DESCRICAO COLLATE Latin1_General_CI_AS as descContaNvl6,
        Nivel1.CODCONTA COLLATE Latin1_General_CI_AS as cdgContaNvl1,
        Nivel1.DESCRICAO COLLATE Latin1_General_CI_AS as descContaNvl1,
        Nivel2.CODCONTA COLLATE Latin1_General_CI_AS as cdgContaNvl2,
        Nivel2.DESCRICAO COLLATE Latin1_General_CI_AS as descContaNvl2,
        Nivel3.CODCONTA COLLATE Latin1_General_CI_AS as cdgContaNvl3,
        Nivel3.DESCRICAO COLLATE Latin1_General_CI_AS as descContaNvl3,
        Nivel4.CODCONTA COLLATE Latin1_General_CI_AS as cdgContaNvl4,
        Nivel4.DESCRICAO COLLATE Latin1_General_CI_AS as descContaNvl4,
        Nivel5.CODCONTA COLLATE Latin1_General_CI_AS as cdgContaNvl5,
        Nivel5.DESCRICAO COLLATE Latin1_General_CI_AS as descContaNvl5,
        Nivel6.ANALITICA,

        -- Lógica de Negócio para Categoria
        CASE 
            WHEN LEFT(Nivel6.CODCONTA, 7) = '6.1.1.1' THEN 'Contribuição para o Sebrae (CSO)'
            WHEN LEFT(Nivel6.CODCONTA, 7) = '6.1.2.1' THEN 'Contribuição Social do Sebrae/NA  (CSN)'
            WHEN LEFT(Nivel6.CODCONTA, 7) = '6.1.2.2' THEN 'CSN Proposta'
            WHEN LEFT(Nivel6.CODCONTA, 7) = '6.2.1.3' THEN 'Aplicações Financeiras'
            WHEN LEFT(Nivel6.CODCONTA, 7) = '6.2.1.2' THEN 'Empresas Beneficiadas'
            WHEN LEFT(Nivel6.CODCONTA, 7) = '6.1.3.2' THEN 'Contrato Interno com Sebrae/NA'
            WHEN LEFT(Nivel6.CODCONTA, 7) = '6.2.1.1' THEN 'Convênios, Subvenções e Auxílios'
            WHEN LEFT(Nivel6.CODCONTA, 7) = '6.2.1.4' THEN 'Outras Receitas'
            WHEN LEFT(Nivel6.CODCONTA, 7) = '6.3.1.1' THEN 'Alienação de Bens'
            WHEN LEFT(Nivel6.CODCONTA, 7) = '6.9.1.1' THEN 'Saldo Financ. Exerc. Anterior'
            WHEN LEFT(Nivel6.CODCONTA, 7) = '3.1.1.1' THEN 'Pessoal'
            WHEN LEFT(Nivel6.CODCONTA, 7) = '3.1.1.2' THEN 'Encargos Sociais'
            WHEN LEFT(Nivel6.CODCONTA, 7) = '3.1.1.3' THEN 'Benefícios Sociais'
            WHEN LEFT(Nivel6.CODCONTA, 7) = '3.1.2.1' THEN 'Serviços Especializados'
            WHEN LEFT(Nivel6.CODCONTA, 7) = '3.1.2.2' THEN 'Serviços Contratados'
            WHEN LEFT(Nivel6.CODCONTA, 7) = '3.1.2.3' THEN 'Encargos Sociais s/Serviços de Terceiros'
            WHEN LEFT(Nivel6.CODCONTA, 7) = '3.1.3.1' THEN 'Despesas com Viagens'
            WHEN LEFT(Nivel6.CODCONTA, 7) = '3.1.3.2' THEN 'Aluguéis e Encargos'
            WHEN LEFT(Nivel6.CODCONTA, 7) = '3.1.3.3' THEN 'Divulgação, Anúncios, Publicidade e Propaganda'
            WHEN LEFT(Nivel6.CODCONTA, 7) = '3.1.3.4' THEN 'Serviços Gráficos e de Reprodução'
            WHEN LEFT(Nivel6.CODCONTA, 7) = '3.1.3.5' THEN 'Serviços de Comunicação em Geral'
            WHEN LEFT(Nivel6.CODCONTA, 7) = '3.1.3.6' THEN 'Materiais de Consumo'
            WHEN LEFT(Nivel6.CODCONTA, 7) = '3.1.3.7' THEN 'Demais Custos e Despesas Gerais'
            WHEN LEFT(Nivel6.CODCONTA, 7) = '3.1.3.8' THEN 'Doações e Subvenções'
            WHEN LEFT(Nivel6.CODCONTA, 7) = '3.1.4.1' THEN 'Despesas Tributárias'
            WHEN LEFT(Nivel6.CODCONTA, 7) = '3.1.4.2' THEN 'Despesas Financeiras'
            WHEN LEFT(Nivel6.CODCONTA, 7) = '3.1.5.3' THEN 'Transf. Externas - Convênios c/Outras Entidades'
            WHEN LEFT(Nivel6.CODCONTA, 7) = '5.1.2.1' THEN 'Bens Imóveis'
            WHEN LEFT(Nivel6.CODCONTA, 7) = '5.1.2.2' THEN 'Bens Móveis'
            WHEN LEFT(Nivel6.CODCONTA, 7) = '5.1.2.3' THEN 'Bens Intangíveis'
            WHEN LEFT(Nivel6.CODCONTA, 7) = '5.1.5.2' THEN 'Fundo de Empresas Emergentes'
            WHEN LEFT(Nivel6.CODCONTA, 7) = '5.1.5.3' THEN 'Microcrédito'
            WHEN LEFT(Nivel6.CODCONTA, 7) = '5.1.4.1' THEN 'Depósitos Judiciais'
            ELSE NULL 
        END AS CATEGORIA,

        -- Lógica de Negócio para Receita/Despesa
        CASE 
            WHEN LEFT(Nivel6.CODCONTA, 1) = '6' THEN 1
            WHEN LEFT(Nivel6.CODCONTA, 1) IN ('3', '5') THEN 2
            ELSE NULL 
        END AS RECEITA_DESPESA

    FROM HUBDADOS.CorporeRM.CCONTA AS Nivel6
    LEFT JOIN HUBDADOS.CorporeRM.CCONTA AS Nivel5 ON LEFT(Nivel6.CODCONTA, 10) = Nivel5.CODCONTA COLLATE Latin1_General_CI_AS
    LEFT JOIN HUBDADOS.CorporeRM.CCONTA AS Nivel4 ON LEFT(Nivel6.CODCONTA, 7) = Nivel4.CODCONTA COLLATE Latin1_General_CI_AS
    LEFT JOIN HUBDADOS.CorporeRM.CCONTA AS Nivel3 ON LEFT(Nivel6.CODCONTA, 5) = Nivel3.CODCONTA COLLATE Latin1_General_CI_AS
    LEFT JOIN HUBDADOS.CorporeRM.CCONTA AS Nivel2 ON LEFT(Nivel6.CODCONTA, 3) = Nivel2.CODCONTA COLLATE Latin1_General_CI_AS
    LEFT JOIN HUBDADOS.CorporeRM.CCONTA AS Nivel1 ON LEFT(Nivel6.CODCONTA, 1) = Nivel1.CODCONTA COLLATE Latin1_General_CI_AS

    -- Filtro para trazer apenas as contas analíticas (onde ocorrem os lançamentos)
    WHERE
        Nivel6.ANALITICA = 1 
)
-- Fim da CTE e início da consulta final
SELECT *
FROM PLANO_CONTAS WHERE Receita_despesa = 2;
