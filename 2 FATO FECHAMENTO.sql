USE FINANCA
;
DECLARE @DATAATUALIZACAO DATETIME
SET @DATAATUALIZACAO = GETDATE()
;
 
WITH TOTAL AS (
SELECT * FROM DBO.FatoFechamento
)
, SELECAO_CONTA_SERVICO AS (
SELECT TIPO, CONTA_FECHAMENTO, UNIFICAVALOR,[DATA] FROM TOTAL
)
,TABELA_DINAMICA_SELECAO AS (
SELECT CONTA_FECHAMENTO 
	, DATA
	, TIPO
	, CASE WHEN YEAR([DATA]) = '2025' THEN [UNIFICAVALOR] ELSE NULL END AS 'VALOR 2025'
	, CASE WHEN YEAR([DATA]) = '2024' THEN [UNIFICAVALOR] ELSE NULL END AS 'VALOR 2024'
	, CASE WHEN YEAR([DATA]) = '2023' THEN [UNIFICAVALOR] ELSE NULL END AS 'VALOR 2023'
	, CASE WHEN YEAR([DATA]) = '2022' THEN [UNIFICAVALOR] ELSE NULL END AS 'VALOR 2022'
	, CASE WHEN YEAR([DATA]) = '2021' THEN [UNIFICAVALOR] ELSE NULL END AS 'VALOR 2021'
	, CASE WHEN YEAR([DATA]) = '2020' THEN [UNIFICAVALOR] ELSE NULL END AS 'VALOR 2020'
	, CASE WHEN YEAR([DATA]) = '2019' THEN [UNIFICAVALOR] ELSE NULL END AS 'VALOR 2019'
	, CASE WHEN YEAR([DATA]) = '2018' THEN [UNIFICAVALOR] ELSE NULL END AS 'VALOR 2018'
	FROM SELECAO_CONTA_SERVICO
)
, TABELA_DINAMICA AS (
SELECT CONTA_FECHAMENTO
	, TIPO
	,SUM([VALOR 2025]) AS 'SOMA2025'
	,SUM([VALOR 2024]) AS 'SOMA2024'
	,SUM([VALOR 2023]) AS 'SOMA2023'
	,SUM([VALOR 2022]) AS 'SOMA2022'
	,SUM([VALOR 2021]) AS 'SOMA2021'
	,SUM([VALOR 2020]) AS 'SOMA2020'
	,SUM([VALOR 2019]) AS 'SOMA2019'
	,SUM([VALOR 2018]) AS 'SOMA2018'
FROM TABELA_DINAMICA_SELECAO
GROUP BY TIPO, CONTA_FECHAMENTO
)
INSERT INTO _fOrcamentoAgregado([ContaFechamento], [ReceitaDespesa], [Data], [2024], [2023], [2022], [2021], [2020], [2019], [2018]) 
SELECT CONTA_FECHAMENTO, CASE WHEN TIPO LIKE 'Receita' THEN CAST(1 AS bit) ELSE CAST(0 AS BIT) END AS 'ReceitaDespesa', @DATAATUALIZACAO ,SOMA2024, SOMA2023, SOMA2022, SOMA2021, SOMA2020, SOMA2019, SOMA2018 
FROM TABELA_DINAMICA
 
 
SELECT * FROM _fOrcamentoAgregado